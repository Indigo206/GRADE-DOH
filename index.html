<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html lang="en" xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">

<head>
    <meta name="generator" content="HTML Tidy for Linux (vers 25 March 2009), see www.w3.org" />

    <title>GRADE Determinants of Health/Fundamental economic and social rights</title>
    <meta http-equiv="content-type" lang="en" content="text/html; charset=us-ascii" xml:lang="en" />
    <link href="https://fonts.googleapis.com/css?family=Open+Sans&amp;display=swap" rel="stylesheet" type="text/css" />
    <link rel="icon" href="data:," />
    <link rel="stylesheet" type="text/css" href="style.css">
    </style>
</head>

<body>

    <script src="https://d3js.org/d3.v3.min.js" type="text/javascript">
    </script>
    <script src="https://d3js.org/queue.v1.min.js" type="text/javascript">
    </script>
    <script src="https://d3js.org/topojson.v1.min.js" type="text/javascript">
    </script>
    <script src='https://cdn.plot.ly/plotly-latest.min.js'>
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/spin.js/2.3.2/spin.js">
    </script>

    <script src="tooltip.js" type="text/javascript">
    </script>
    <script src="d3-legend.min.js" type="text/javascript">
    </script>

    <div class="all">
        <div class="menu">
            <div class="inline-div">
                <div class="item">
                    <a href=http://med.st-andrews.ac.uk/grade />
                    <h2 class="label success new-label"><span class="align">GRADE Homepage</span></h2>
                    </a>
                </div>
            </div>

            <h2>GRADE Determinants of Health/Fundamental economic and social rights</h2>

            <p>
            <ul>
                <li>Hover over a country to show information</li>
                <li>Click a country/select from the list to focus</li>
                <li>Click oceans to reset view</li>
                <li></li>
            </ul>
            </p>

            <div>
                <select id="countrylist" name="country">
                    <option value="$-ALL">
                        Show all countries
                    </option>
                </select>

                <p>Specify revenue as:</p><select id="methodlist" name="method">
                    <option value="newgrpc">
                        New government revenue per capita
                    </option>

                    <option value="percentage">
                        Increase as percentage of gov. rev. per capita
                    </option>

                    <option value="absolute">
                        Absolute additional revenue
                    </option>

                    <option value="pc">
                        Additional revenue per capita
                    </option>
                </select>

                <select id="prefix" name="prefix">
                    <option value="U">
                        USD
                    </option>

                    <option value="M">
                        Millions (M) USD
                    </option>

                    <option value="B">
                        Billions (B) USD
                    </option>
                </select>
            </div>

            <div class="sliders">
                <div class="slidecontainer">
                    <div id="revDiv">
                        <input type="number" name="revSlider" id="revSlider" class="numeric" min="0" max="100" value="0" />

                        <p>Additional Revenue (% of GRpC): <span id="revenueVal">0%</span></p>
                    </div>

                    <div id="absRevDiv">
                        <input type="number" name="absRevSlider" id="absRevSlider" class="numeric" min="0" max="1000" value="0" />

                        <p>Additional Revenue (USD): <span id="absRevenueVal">$0M</span></p>
                    </div>

                    <div id="pcRevDiv">
                        <input type="number" name="pcRevSlider" id="pcRevSlider" class="numeric" min="0" max="1000" value="0" />

                        <p>Additional Revenue (USD per capita): <span id="perCapitaRevenueVal">$0</span></p>
                    </div>

                    <div id="grpcdiv">
                        <input type="number" name="grpcSlider" id="grpcSlider" class="numeric" min="0" max="1000" value="0" />

                        <p>New gov. rev. per capita(USD): <span id="grpcVal">$0</span></p>
                    </div>
                </div>


                <!--
        <p>Governance measure:</p><select id="govList" name="gov">
        </select>
        -->

                <div class="slidecontainer">
                    <input type="range" name="govSlider" id="govSlider" class="slider" min="0" max="200" value="100" />
                    <img src="img/larrow.png" style="width: 60px; height: auto;" />worsening&nbsp&nbsp&nbsp<span class="ar">improving <img src="img/rarrow.png" style="width: 60px; height : auto" /></span>

                    <p>Governance quality: <span id="govVal">0</span></p>
                </div>

                <div class="slidecontainer">
                    <input type="range" name="yearSlider" id="yearSlider" class="slider" min="1980" max="2020" value="2017" />

                    <p>Year: <span id="yearVal"></span></p>
                </div>
                <select id="outcomes" name="outcome">
                </select>
            </div>


            <h4>Download raw data</h4>
            <ul>
                <li><a href="BASE%20data.xlsx">Excel (including notes on data)</a></li>
                <li><a href="BASE%20data.csv">CSV</a></li>
            </ul>
            <p id="version">v0.8 17/01/2021</p>
            <div>

            </div>
        </div>
        <div id="vis"></div>
        <div class="output" , id="countrydata">
            <p>
                <span id="countrytext"></span>
            </p>
        </div>
        <div class="plotwrapper" id = "plotwrapper">
            <div class="plot" id="plot">
                <!---
             Result to show <select id="countrylist" name="country">
                </select>
            --->
            </div>
            <div class="plottools">
                <button onclick="download_csv()">Download plot data</button> 
                <!---
                <select name="plottype" id="plottype">
                    <option value="u5m">Under-5 deaths averted</option>
                    <option value="mmr">Maternal deaths averted</option>
                    <option value="population">Population affected</option>
                </select>
                --->
            </div>
        </div>
    </div>
    <script src="popdata.js" type="text/javascript"></script>
    <script src="grade.js" type="text/javascript"></script>
    <script src="model.js" type="text/javascript"></script>
    <script src="linterp.js" type="text/javascript"></script>
    <script type="text/javascript">
        var width = screen.width * 0.8;
        var height = screen.height * 0.6;
        var plotheight = 400;

        // spinner
        var opts = {
        lines: 20, // The number of lines to draw
        length: 0, // The length of each line
        width: 15, // The line thickness
        radius: 42, // The radius of the inner circle
        scale: 0.85, // Scales overall size of the spinner
        corners: 1, // Corner roundness (0..1)
        color: ["#e09900"], // CSS color or array of colors
        fadeColor: ["#dee5f8"], // CSS color or array of colors
        opacity: 0.05, // Opacity of the lines
        rotate: 0, // The rotation offset
        direction: 1, // 1: clockwise, -1: counterclockwise
        speed: 1, // Rounds per second
        trail: 74, // Afterglow percentage
        fps: 20, // Frames per second when using setTimeout() as a fallback in IE 9
        zIndex: 2e9, // The z-index (defaults to 2000000000)
        className: 'spinner', // The CSS class to assign to the spinner
        top: '50%', // Top position relative to parent
        left: '50%', // Left position relative to parent
        shadow: 0, // Box-shadow for the lines
        position: 'absolute' // Element positioning
        };

        var target = document.getElementById('vis');
        var spinner = new Spinner(opts).spin(target);

        const zoom = d3.behavior.zoom()
            .scaleExtent([1, 8])
            .on("zoom", zoomed);

        function zoomed(event) {
            svg.style("stroke-width", 1.5 / d3.event.scale + "px");
            svg.attr("transform", "translate(" + d3.event.translate + ")scale(" + d3.event.scale + ")");
        }

        function clicked(d) {
            //if (active.node() === this) return reset();
            //active.classed("active", false);
            //active = d3.select(this).classed("active", true);


            const maxScale = 0.85;
            const maxiScale = 8;

            var bounds = path.bounds(d),
                ww = bounds[1][0] - bounds[0][0],
                hh = bounds[1][1] - bounds[0][1],
                x = (bounds[0][0] + bounds[1][0]) / 2,
                y = (bounds[0][1] + bounds[1][1]) / 2,
                scale = Math.max(1, Math.min(maxiScale, maxScale / Math.max(ww / width, hh / height))),
                translate = [width / 2 - scale * x, height / 2 - scale * y];

            svg.transition()
                .duration(transitionTime * 2)
                .call(zoom.translate(translate).scale(scale).event);

            if (d.hasOwnProperty("id")) {
                country = d.id;
                d3.select('#countrylist').property('value', d.id);
                mainUpdate();
            }
        }

        function reset() {
            //active.classed("active", false);
            //active = d3.select(null);

            resetview();

            country = "$-ALL"
            d3.select('#countrylist').property('value', "$-ALL");
            mainUpdate();

            d3.event.stopPropagation();
        }

        function resetview() {
            svg.transition()
                .duration(transitionTime * 2)
                .call(zoom.translate([0, 0]).scale(1).event);
        }

        function stop() {
            if (d3.event.defaultPrevented) d3.event.stopPropagation();
        }

        var svg = d3.select('#vis').append('svg')
            .attr('width', width)
            .attr('height', height)
            .call(zoom)
            //.on("zoom", redraw))
            .on("click", stop, true)
            .append("g");

        svg.append("rect")
            .attr("width", width)
            .attr("height", height)
            .style("fill", "white")
            .on("click", reset);

        var svg2 = d3.select('#vis').append('svg')
            .attr('width', width)
            .attr('height', subheight)
            .call(zoom)
            //.on("zoom", redraw))
            .append("g");

        svg
            .call(zoom) // delete this line to disable free zooming
            .call(zoom.event);

        svg2
            .call(zoom) // delete this line to disable free zooming
            .call(zoom.event);

        function redraw() {
            svg.attr("transform", "translate(" + d3.event.translate +
                ")scale(" + d3.event.scale + ")");
        }

        function focusCountry() {
            if (country.slice(0, 2) == "$-") {
                resetview();
                return;
            }

            //svg.transition(transitionTime * 2).attr("transform", "translate(10,10)scale(5)");
            var found_country = svg.selectAll('path.countries')
                .filter(function(d, i) {
                    return d.id == country;
                })

            if (found_country.length == 1) {
                clicked(found_country.data()[0]);
            }
        }

        function mainUpdate() {
            //updateLegend();
            updateCountries();
        }

        var projection = d3.geo.mercator()
            .scale(225)
            .translate([width / 2, height / 2]);

        var path = d3.geo.path()
            .projection(projection);

        var colorScale = d3.scale.linear().
        range([outcomesMap.get(outcome).loCol, outcomesMap.get(outcome).hiCol]).
        interpolate(d3.interpolateLab);

        queue()
            .defer(d3.json, "countries.json")
            .defer(d3.csv, "BASE data.csv", typeAndSetPopulation)
            .await(loaded);

    </script>
</body>

</html>
